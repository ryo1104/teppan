
<% @page_title = "プロフィール編集" %>
<% breadcrumb :edit_user, current_user %>
<div class="page-body-container">
  <p><%= breadcrumbs separator: "  &rsaquo;  ", :class => "breadcrumbs custom" %></p>
  <div class="row">
    <div class="col s12 m9 user-page">
      <h1 class="h1_class">プロフィール編集</h1>
      <div class="collection z-depth-0 user-page">
        <% if @no_nickname %>
          <%= form_with model: @user, local: true, method: :patch do |f| %>
            ユーザー名を登録して下さい。
            <div class="user-form-nickname">ユーザー名
              <%= f.text_field :nickname, placeholder: @temp_nickname, :class => "browser-default" %>
            </div>
            <%= f.submit "保存", class: "btn btn-primary withripple custom" %>
          <% end %>
        <% else %>
          <%= form_with model: @user, local: true, method: :patch do |f| %>
            <div class="user-profile-edit-tophalf">
              <div class="col s3 m3 user-page-left">
                <div class="user-page-avatar-container">
                  <% if @user.avatar.present? %>
                    <%= image_tag @user.avatar, {:class => "circle", :id => "user-page-image"} %>
                    <%= link_to "削除", delete_avatar_path(@user.id), :method => :delete %>
                  <% else %>
                    <%= image_pack_tag "no_user_image.png", {:class => "circle", :id => "user-page-image"} %>
                  <% end %>
                </div>
                <label>
                  <div class="filelabel" title="ファイルを選択">
                    <i class="material-icons photo-upload custom">photo_camera</i>
                  </div>
                  <%= f.file_field :image, {:id => "user-image-upload"} %>
                </label>
                <div class="user-profile-completion">
                  完成度(<%= @profile_gauge %>%)
                  <div class="progress custom">
                    <div class="determinate" style="width: <%= @profile_gauge.to_s %>%"></div>
                  </div>
                </div>
              </div>
              <div class="col s9 m9 user-page-info">
                <div class="user-form-nickname">
                  <%= f.label :nickname, "ユーザー名" %>
                  <%= f.text_field :nickname, placeholder: "ユーザー名" %>
                </div>
                <div class="birth_date_fields">
                  <label for="user_birthdate">生年月日</label><br>
                  <input id="user_birthdate" name="user[birthdate]" type="date" value="<%= @user.birthdate %>"/>
                </div>
                <div class="prefecture_form">
                  <%= f.label :prefecture_code, "エリア" %><br>
                  <%= f.collection_select :prefecture_code, JpPrefecture::Prefecture.all, :code, :name, {:include_blank => '都道府県'}, {class: 'form-control prefecture'} %>
                </div>
                <div class="gender_form">
                  <label for="user_gender_1">
                    <%= f.radio_button :gender, 1, :class => "with-gap" %>
                    <span>男性</span>
                  </label>
                  <label for="user_gender_2">
                    <%= f.radio_button :gender, 2, :class => "with-gap" %>
                    <span>女性</span>
                  </label>
                </div>
              </div>
            </div>
            <div class="user-profile-edit-bottomhalf">
              <div class="user-introduction">
                <%= f.label :introduction, "プロフィール文" %>
                <%= f.text_area :introduction, style: 'width: 100%; height: 200px;', maxlength: 800, placeholder: "（８００字以内）" %>
              </div>
              <%= f.submit "更新", class: "btn btn-primary withripple custom" %>
            </div>
          <% end %>
        <% end %>
      </div>
    </div>
  </div>
</div>
<script>
$(function(){
  $('#user-image-upload').change(function(e){
    var file = e.target.files[0];
    var reader = new FileReader();
 
    if(file.type.indexOf("image") < 0){
      alert("画像ファイルを指定してください。");
      return false;
    }
 
    reader.onload = (function(file){
      return function(e){
        $("#user-page-image").attr("src", e.target.result);
        $("#user-page-image").attr("title", file.name);
      };
    })(file);
    reader.readAsDataURL(file);
  });
});
</script>